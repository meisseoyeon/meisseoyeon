name: Jira Issue & Branch Sync

on:
  issues:
    types: [opened]

jobs:
  create-jira-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ë¸Œëœì¹˜ ìƒì„±ì„ ìœ„í•´ í•„ìˆ˜
      issues: write    # ì´ìŠˆ ìˆ˜ì • ë° ëŒ“ê¸€ ì‘ì„±ì„ ìœ„í•´ í•„ìˆ˜

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. ì–´ë–¤ í…œí”Œë¦¿ì„ ì¼ëŠ”ì§€ ë¼ë²¨ë¡œ íŒë‹¨
      - name: Determine Issue Template & Branch Prefix
        id: template-check
        run: |
          # ë¼ë²¨ì— 'ë²„ê·¸'ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ë²„ê·¸ ë¦¬í¬íŠ¸
          if [[ "${{ contains(github.event.issue.labels.*.name, 'ğŸ› ë²„ê·¸') }}" == "true" ]]; then
            echo "template_path=.github/ISSUE_TEMPLATE/bug_report.yml" >> $GITHUB_OUTPUT
            echo "branch_prefix=bugfix" >> $GITHUB_OUTPUT
            
          # ë¼ë²¨ì— 'ê¸°ëŠ¥'ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê¸°ëŠ¥ ë¦¬í¬íŠ¸
          elif [[ "${{ contains(github.event.issue.labels.*.name, 'âœ¨ ê¸°ëŠ¥') }}" == "true" ]]; then
            echo "template_path=.github/ISSUE_TEMPLATE/feature_report.yml" >> $GITHUB_OUTPUT
            echo "branch_prefix=feature" >> $GITHUB_OUTPUT
            
          # ê·¸ ì™¸ì—ëŠ” ì»¤ìŠ¤í…€(Task) ë¦¬í¬íŠ¸
          else
            echo "template_path=.github/ISSUE_TEMPLATE/custom_report.yml" >> $GITHUB_OUTPUT
            echo "branch_prefix=task" >> $GITHUB_OUTPUT
          fi

      # 2. ì´ìŠˆ í…œí”Œë¦¿ ë‚´ìš© ë¶„ì„ (ë™ì ìœ¼ë¡œ ê²½ë¡œ ì„¤ì •)
      - name: Parse Issue Template
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: ${{ steps.template-check.outputs.template_path }}

      # 3. Jira ë¡œê·¸ì¸
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 4. Jira ì´ìŠˆ ìƒì„±
      - name: Create Jira Issue
        id: create
        uses: atlassian/gajira-create@v3
        with:
          project: "CPG"  # [í™•ì¸] ë³¸ì¸ í”„ë¡œì íŠ¸ í‚¤ë¡œ ìˆ˜ì •
          issuetype: "${{ steps.issue-parser.outputs.issueparser_issueType }}"
          summary: "[BE] ${{ github.event.issue.title }}"
          description: |
            h2. Description
            ${{ steps.issue-parser.outputs.issueparser_details }}

            ----
            [GitHub Issue Link|${{ github.event.issue.html_url }}]

      # 5. ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸ (ì§€ë¼ í‚¤ í¬í•¨)
      - name: Update GitHub Issue Title
        uses: actions-cool/issues-helper@v3
        with:
          actions: "update-issue"
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "[${{ steps.create.outputs.issue }}] ${{ github.event.issue.title }}"

     
