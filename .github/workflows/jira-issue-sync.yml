name: Jira Issue & Branch Sync

on:
  issues:
    types: [opened]

jobs:
  create-jira-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ë¸Œëœì¹˜ ìƒì„±ì„ ìœ„í•´ í•„ìˆ˜
      issues: write    # ì´ìŠˆ ìˆ˜ì • ë° ëŒ“ê¸€ ì‘ì„±ì„ ìœ„í•´ í•„ìˆ˜

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. ì´ìŠˆ í…œí”Œë¦¿ ë‚´ìš© ë¶„ì„ (Parsing)
      # í…œí”Œë¦¿ íŒŒì¼(.github/ISSUE_TEMPLATE/ì´ìŠˆíŒŒì¼ëª….yml)ì˜ ê²½ë¡œë¥¼ ì •í™•íˆ ë§ì¶°ì£¼ì„¸ìš”!
      - name: Parse Issue Template
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/jira_issue_form.yml # [ì¤‘ìš”] ì‹¤ì œ í…œí”Œë¦¿ íŒŒì¼ëª…ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”

      # 2. Jira ë¡œê·¸ì¸
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 3. Jira ì´ìŠˆ ìƒì„±
      - name: Create Jira Issue
        id: create
        uses: atlassian/gajira-create@v3
        with:
          project: "CPG"  # [í™•ì¸] ë³¸ì¸ í”„ë¡œì íŠ¸ í‚¤ (ì˜ˆ: URECA, CPG ë“±)
          
          # í…œí”Œë¦¿ì—ì„œ ì„ íƒí•œ Issue Type (Task, Story)ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
          issuetype: "${{ steps.issue-parser.outputs.issueparser_issueType }}"
          
          summary: "[BE] ${{ github.event.issue.title }}"
          
          # ìƒì„¸ ë‚´ìš©ê³¼ ì°¸ì¡° ë§í¬ë¥¼ ì¡°í•©í•´ì„œ ì§€ë¼ ë³¸ë¬¸ì— ë„£ìŒ
          description: |
            h2. Description
            ${{ steps.issue-parser.outputs.issueparser_details }}

            h2. References
            ${{ steps.issue-parser.outputs.issueparser_references }}

            ----
            [GitHub Issue Link|${{ github.event.issue.html_url }}]
            
      # 5. ê¹ƒí—ˆë¸Œ ì´ìŠˆ ì œëª© ì—…ë°ì´íŠ¸
      - name: Update GitHub Issue Title
        uses: actions-cool/issues-helper@v3
        with:
          actions: "update-issue"
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "[${{ steps.create.outputs.issue }}] ${{ github.event.issue.title }}"

      # 6. ëŒ“ê¸€ë¡œ ì•Œë¦¼ (ì§€ë¼ ë§í¬ + ìƒì„±ëœ ë¸Œëœì¹˜ëª…)
      - name: Add Comment
        uses: actions/github-script@v6
        env:
          TICKET_KEY: ${{ steps.create.outputs.issue }}
          JIRA_URL: ${{ secrets.JIRA_BASE_URL }}
          BRANCH: ${{ env.CREATED_BRANCH }}
        with:
          script: |
            const { TICKET_KEY, JIRA_URL, BRANCH } = process.env;
            
            const body = `
            âœ… **Jira Issue Created**: [${TICKET_KEY}](${JIRA_URL}/browse/${TICKET_KEY})
            ğŸŒ¿ **Branch Created**: \`${BRANCH}\`
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
