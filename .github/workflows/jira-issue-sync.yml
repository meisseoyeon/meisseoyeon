name: Create Jira Issue & Branch

on:
  issues:
    types: [opened]

jobs:
  create-issue-and-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ë¸Œëœì¹˜ë¥¼ ìƒì„±(push)í•˜ë ¤ë©´ ì´ ê¶Œí•œì´ ê¼­ í•„ìš”í•©ë‹ˆë‹¤!
      issues: write    # ì´ìŠˆì— ëŒ“ê¸€ì„ ë‹¬ë ¤ë©´ í•„ìš”í•©ë‹ˆë‹¤.

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Login to Jira
        uses: atlassian/gajira-login@master
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      - name: Create Jira Issue
        id: create
        uses: atlassian/gajira-create@master
        with:
          project: "CPG"   # ë³¸ì¸ í”„ë¡œì íŠ¸ í‚¤ í™•ì¸
          issuetype: "Task"
          summary: "${{ github.event.issue.title }}"
          description: "${{ github.event.issue.body }} \n\n [GitHub Issue Link](${{ github.event.issue.html_url }})"

      - name: Create Git Branch with Jira Key
        run: |
          # 1. ì§€ë¼ í‹°ì¼“ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (ì˜ˆ: CPG-101)
          TICKET_KEY="${{ steps.create.outputs.issue }}"
          
          # 2. ë¸Œëœì¹˜ ì´ë¦„ ë§Œë“¤ê¸° (feature/CPG-101-ì´ìŠˆì œëª©)
          # ê³µë°±ì€ í•˜ì´í”ˆ(-)ìœ¼ë¡œ ë³€ê²½
          SAFE_TITLE=$(echo "${{ github.event.issue.title }}" | sed 's/ /-/g')
          BRANCH_NAME="feature/${TICKET_KEY}-${SAFE_TITLE}"
          
          # 3. ë¸Œëœì¹˜ ìƒì„± ë° í‘¸ì‹œ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          # 4. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì“°ê¸° ìœ„í•´ ë³€ìˆ˜ ì €ì¥
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update GitHub Issue Title
        uses: actions/github-script@v6
        with:
          script: |
            const ticketKey = '${{ steps.create.outputs.issue }}';
            const originalTitle = context.payload.issue.title;
            
            // ì œëª©ì„ "[CPG-101] ì›ë˜ ì œëª©" ìœ¼ë¡œ ë³€ê²½
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              title: `[${ticketKey}] ${originalTitle}`
            })

      - name: Add Comment
        uses: actions/github-script@v6
        with:
          script: |
            const ticketKey = '${{ steps.create.outputs.issue }}';
            const branchName = process.env.BRANCH_NAME;
            const jiraUrl = '${{ secrets.JIRA_BASE_URL }}/browse/' + ticketKey;
            
            const body = `âœ… **Jira Issue Created**: [${ticketKey}](${jiraUrl}) \nğŸŒ¿ **Branch Created**: \`${branchName}\``;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })
